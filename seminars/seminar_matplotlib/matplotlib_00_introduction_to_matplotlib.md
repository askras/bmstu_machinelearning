---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.16.4
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

# Визуализация с помощью Matplotlib


Рассмотрим пакет для визуализации на Python &mdash; Matplotlib.
Matplotlib &mdash; это мультиплатформенная библиотека визуализации данных, основанная на основе массивов NumPy и предназначенная для работы с богатым стеком SciPy.
Она былв задумана Джоном Хантером в 2002 году, изначально как патч к IPython для возможности интерактивного построения графиков в стиле MATLAB через `gnuplot` из командной строки IPython.
Создатель IPython Фернандо Перес в то время был занят завершением своей докторской диссертации и сообщил Джону, что у него не будет времени на рассмотрение патча в течение нескольких месяцев.
Джон воспринял это как сигнал к самостоятельной работе, так и появился пакет Matplotlib, версия 0.1 которого была выпущена в 2003 году.
Институт исследований космоса с помощью космического телескопа (Space Telescope Science Institute, занимающийся управлением телескопом &laquo;Хаббл&raquo;) финансово поддержал разработку пакета Matplotlib и обеспечил расширение его возможностей, избрав в качестве пакета для формирования графических изображений.

Одной из важнейших особенностей Matplotlib является его способность хорошо работать со многими операционными системами и графическими бэкэндами.
Matplotlib поддерживает десятки бэкэндов и типов выходных данных, а это значит, что пользователь может рассчитывать на его работу независимо от используемой операционной системы или формата выходных данных.
Этот кроссплатформенный подход &laquo;все для всех&raquo; стал одной из самых сильных сторон Matplotlib.
Это способствовало его популярности среди пользователей, что, в свою очередь, привело к появлению активной базы разработчиков. Все это обеспечило появление увелеичение возможностей Matplotlib и его повсеместному распространению в научном мире Python.

Однако в последние годы интерфейс и стиль Matplotlib начали устаревать.
На фоне новых утилит, таких как ggplot и ggvis в языке R, а также веб-инструментов визуализации, основанных на D3js и HTML5 Canvas, Matplotlib кажется неуклюжим и старомодным. 
Тем не менее, нельзя игнорировать преимущества Matplotlib как хорошо протестированного кроссплатформенного графического движка.

Последние версии Matplotlib позволяют относительно легко устанавливать новые глобальные стили построения графиков (см. [Настройка Matplotlib: конфигурации и таблицы стилей](matplotlib_11_settings_and_stylesheets.md)). Разрабатываются новые пакеты, которые основываются на его мощных внутренних возможностях, чтобы управлять Matplotlib через новые более удобные и современные API, например, Seaborn (обсуждается в [Настройка Matplotlib: конфигурации и таблицы стилей](matplotlib_11_settings_and_stylesheets.md), и даже сам Pandas можно использовать в качестве обертки вокруг API Matplotlib.

Однако даже при наличии подобных адаптеров полезно разобраться в синтаксисе Matplotlib для настройки вывода итогового графика. 
Исходя из всего этого, сама библиотека Matplotlib остается жизненно важной частью стека визуализации данных, даже если новые инструменты приводят к тому, что сообщество пользователей постепенно отходит от непосредственного использования API Matplotlib.


## Общие советы по Matplotlib

Прежде чем углубиться в детали создания визуализаций с помощью Matplotlib, есть несколько полезных вещей, на которые следует обратить внимние при использовании этого пакета.


### Импорт Matplotlib

при импорте Matplotlib принято использовать псевдонимы:

```python
import matplotlib as mpl
import matplotlib.pyplot as plt
import IPython
```

Чаще всего используется интерфейс `plt`.


### Настройка стилей

За выбор подходящих стилей при построении графиков отвечает директива `plt.style`.
Будем использовать стиль `default`, которая гарантирует, что создаваемые графики будут использовать прстой и лаконичный вид.

```python
plt.style.use('default')
```

Будем корректировать этот стиль по мере необходимости.
Дополнительную информацию о таблицах стилей смотрите в разделе [Настройка Matplotlib: конфигурации и таблицы стилей](matplotlib_11_settings_and_stylesheets.md) и на странице [Style sheets reference](https://matplotlib.org/stable/gallery/style_sheets/style_sheets_reference.html) официальной документации Matplotlib.


### Использовать или не использовать `show()`? Как отображать ваши графики?


Существует три возможных контекста использования Matplotlib:
- в скрипте;
- в терминале IPython;
- в блокноте IPython.


#### Построение графиков из скрипта

При использовании Matplotlib из скрипта, вызов функции `plt.show()` необходим.
`plt.show()` запускает цикл событий, ищет все активные в данный момент объекты графиков и открывает одно или несколько интерактивных окон, в которых и отображаются все активные графики. 
Команда `plt.show()` выполняет множество скрытых функций, поскольку она должна взаимодействовать с интерактивной графической прикладной частью системы.
Детали этой операции могут существенно различаться в зависимости от системы и даже установки, но Matplotlib делает все возможное, чтобы скрыть от пользователя все эти детали.

Допустим имеется файл `myplot.py`, содержащий следующий код:

```python
# %load ./scripts/myplot.py
import matplotlib.pyplot as plt
import numpy as np

x = np.linspace(0, 10, 100)

plt.plot(x, np.sin(x))
plt.plot(x, np.cos(x))

plt.show()

```

Можно запустить этот скрипт из командной строки, в результате чего откроется окно с изображением вашего рисунка:

```bash
python ./scripts/myplot.py
```

Следует помнить следующее: команду `plt.show()` следует использовать *только один раз* за сеанс Python, и чаще всего ее можно увидеть в самом конце скрипта.
Множественные команды `show()` могут привести к непредсказуемому поведению, зависящему от используемой системы и ее настроек, и их следует избегать.


#### Построение графиков из оболочки IPython

Matplotlib очень удобно использовать интерактивно в оболочке IPython.
IPython будет отлично работать с Matplotlib, если перевести его в режим Matplotlib.
Чтобы включить этот режим, нужно использовать магическую команду `%matplotlib` после запуска `ipython`:


```ipython
In [1]: %matplotlib
Using matplotlib backend: TkAgg

In [2]: import matplotlib.pyplot as plt
```


После этого любая команда `plt.plot` приведет к открытию интерактивного окна графика в котором можно будет выполнить дополнительные команды для обновления графика.
Некоторые изменения (например, изменение свойств уже нарисованных линий) не будут отрисованы автоматически.
В таких случаях, для принудительного обновления используется `plt.draw()`.
Использование `plt.show()` в режиме Matplotlib не требуется.


#### Построение графиков из блокнота IPython

Интерактивное построение графиков в блокноте IPython можно выполнить с помощью команды `%matplotlib`, которая работает так же, как и в терминале IPython.
В блокноте IPython также есть возможность встраивать графику непосредственно в блокнот двумя возможными способами:

- использование команды `%matplotlib inline` приведет к включению в блокнот *статических* изображениям вашего графиков;
- использование команды `%matplotlib widget` приведет к включению в блокнот *интерактивных* графиков (требует установки пакета `ipympl`).

```python
%matplotlib inline
```

После выполнения этой команды (ее необходимо выполнить только один раз для каждого ядра/сеанса) любая ячейка в блокноте, создающая график, встроит изображение PNG с полученной графикой:

```python jupyter={"outputs_hidden": false}
import numpy as np
x = np.linspace(0, 10, 100)

fig = plt.figure()
plt.plot(x, np.sin(x), '-')
plt.plot(x, np.cos(x), '--');
```

### Сохранение рисунков в файл

Приятной особенностью Matplotlib является возможность сохранять рисунки в самых разных форматах.
Сохранить рисунок можно с помощью команды `savefig()`.
Например, чтобы сохранить предыдущий рисунок в виде файла PNG, необходимо выполнить следующую команду:

```python jupyter={"outputs_hidden": false}
fig.savefig('my_graph.png')
```

Теперь в текущем рабочем каталоге есть файл с именем `my_graph.png`:

```bash jupyter={"outputs_hidden": false}

ls -lh my_graph.png
```

Чтобы убедиться, что содержимое этого файла соответствует ожиданиям, воспользуемся объектом Image оболочки IPython для отображения его содержимого:

```python jupyter={"outputs_hidden": false}
from IPython.display import Image
Image('my_graph.png')
```

Команда `savefig()` определяет формат файла по расширению указанного имени файла.
 В зависимости от установленной в системе прикладной графической части, доступно множество различных форматов файлов.
Список поддерживаемых типов файлов для используемой системы можно найти, используя следующий метод объекта `canvas` рисунка::

```python jupyter={"outputs_hidden": false}
fig.canvas.get_supported_filetypes()
```

Обратите внимание, что при сохранении рисунка нет необходимости использовать `plt.show()`.


## Два интерфейса по цене одного

Потенциально запутывающей особенностью Matplotlib является его двойной интерфейс: во-первых, удобный и простой интерфейс на основе состояний в стиле MATLAB, и во-вторых, более мощный объектно-ориентированный интерфейс. 
Рассмотрим их основные различия.


#### Интерфейс в стиле MATLAB

Matplotlib изначально был написан как Python альтернатива для пользователей MATLAB, и большая часть его синтаксиса отражает этот факт.
Инструменты в стиле MATLAB содержатся в интерфейсе `pyplot` (`plt`).
Вот пример:

```python jupyter={"outputs_hidden": false}
plt.figure()  # Создаем основу для графика

# Создаем первую из двух областей графика, состоящего из двух панелей и задаем текущую ось
plt.subplot(2, 1, 1) # (2 строки, 1 столбец, текущая панель 1)
plt.plot(x, np.sin(x))

# Создаем вторую из двух областей графика, состоящего из двух панелей и задаем текущую ось
plt.subplot(2, 1, 2) # (2 строки, 1 столбец, текущая панель 2)
plt.plot(x, np.cos(x));
```

Важно отметить, что этот интерфейс *отслеживает состояние*: он отслеживает &laquo;текущий&laquo; рисунок и оси, к которым применяются все команды `plt`.
Ссылку на них можно получить с помощью процедур `plt.gcf()` (get current figure &mdash; получить текущую фигуру) и `plt.gca()` (get current axes &mdash; получить текущие оси (координат)).

Хотя этот интерфейс с отслеживанием состояния быстр и удобен при построении простых графиков, его использование может привести к проблемам.
Например, как после создания второй панели вернуться и что-то добавить к первой?
Это возможно в интерфейсе в стиле MATLAB, но очень неудобно.
К счастью, есть лучший способ.


#### Объектно-ориентированный интерфейс

Объектно-ориентированный интерфейс подходит для более сложных ситуаций, а также для случаев, когда требуется больше контроля над создаваемым графиком.
Вместо того чтобы зависеть от некоторого понятия &laquo;активной&raquo; рисунка или осей, в объектно-ориентированном интерфейсе функции построения графиков являются *методами* явным образом определяемых объектов `Figure` и `Axes`.
Чтобы воссоздать предыдущий график, используя этот стиль построения графиков, можно сделать следующее:

```python jupyter={"outputs_hidden": false}
# Создаем сетку областей для графиков
# ax будет массивом из двух объектов Axes
fig, ax = plt.subplots(2)

# Вызываем метод plot() соответствующего объекта
ax[0].plot(x, np.sin(x))
ax[1].plot(x, np.cos(x));
```

Для более простых графиков выбор используемого стиля во многом является вопросом предпочтений, но объектно-ориентированный подход может стать необходимостью по мере усложнения графиков.
На практике довольно часто приходиться между интерфейсами в стиле MATLAB и объектно-ориентированными интерфейсами в зависимости от того, что наиболее удобно.
В большинстве случаев разница заключается всего лишь в замене `plt.plot()` на `ax.plot()`, но есть несколько подводных камней, которые рассмотрим по мере их возникновения в следующих разделах.
